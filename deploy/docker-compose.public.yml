version: "3.9"

services:
  jivan:
    image: python:3.12-slim
    container_name: jivan-app
    working_dir: /app
    command: >
      sh -c "pip install --no-cache-dir -r requirements.txt &&
             python main.py"
    env_file:
      - ../.env
    volumes:
      - ../:/app
    restart: unless-stopped
    depends_on:
      - redis
    networks:
      - app_net

  redis:
    image: redis:7-alpine
    container_name: jivan-redis
    command: ["redis-server", "--appendonly", "yes", "--save", "60", "1000"]
    volumes:
      - redis_data:/data
    restart: unless-stopped
    networks:
      - app_net

  nginx:
    image: nginx:alpine
    container_name: jivan-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - jivan
    restart: unless-stopped
    networks:
      - app_net

  tailscale:
    image: tailscale/tailscale:stable
    container_name: jivan-tailscale
    hostname: jivan-server
    environment:
      - TS_AUTHKEY=${TS_AUTHKEY}
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_EXTRA_ARGS=--accept-routes
      - TS_USERSPACE=false
    volumes:
      - tailscale_state:/var/lib/tailscale
    cap_add:
      - NET_ADMIN
      - NET_RAW
    restart: unless-stopped
    network_mode: host

  fail2ban:
    image: crazymax/fail2ban:latest
    container_name: jivan-fail2ban
    network_mode: host
    cap_add:
      - NET_ADMIN
      - NET_RAW
    volumes:
      - ./fail2ban:/data:rw
      - /var/log:/var/log:ro
    restart: unless-stopped

  uptime-kuma:
    image: louislam/uptime-kuma:1
    container_name: jivan-uptime-kuma
    volumes:
      - uptime_kuma_data:/app/data
    restart: unless-stopped
    ports:
      - "3001:3001"
    networks:
      - app_net

volumes:
  redis_data:
  tailscale_state:
  uptime_kuma_data:

networks:
  app_net:
